# 招采审计系统 - 业务架构设计

> 最后更新时间：2026-02-05

## 1. 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                  用户界面                                    │
│                              (React Web App)                                │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐    │
│  │  项目列表 │ │ 新建项目  │ │ 项目工作区│ │ 审计执行  │ │ 风险报告  │    │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                               App 端后端                                     │
│                        (Express.js + MySQL)                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  项目管理   │  │  文件管理   │  │  字段管理   │  │  审计风险   │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────────────────────┘
           │                                              │
           ▼                                              ▼
┌─────────────────────────────┐          ┌─────────────────────────────────────┐
│        数据中台              │          │           智能体平台                 │
│    (元数据 + 规则配置)       │          │      (AI 能力服务)                   │
│                             │          │                                     │
│  • 文件类型定义              │◄────────►│  • 关键信息提取 Agent               │
│  • 字段定义                  │          │  • 文件分拣 Agent                   │
│  • 审计规则                  │          │  • 审计执行 Agent                   │
│  • 法规条款                  │          │  • 知识库服务                       │
└─────────────────────────────┘          └─────────────────────────────────────┘
```

---

## 2. 技术栈

### 2.1 前端
| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.3 | UI 框架 |
| TypeScript | 5.5 | 类型系统 |
| Vite | 5.3 | 构建工具 |
| React Router | 6.25 | 路由管理 |
| Tailwind CSS | 3.4 | 样式框架 |
| Radix UI | - | 无障碍组件库 |
| Axios | 1.7 | HTTP 客户端 |
| Zustand | 4.5 | 状态管理 |
| xlsx | - | Excel 导出 |
| file-saver | - | 文件下载 |

### 2.2 后端
| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | 18+ | 运行环境 |
| Express | 4.x | Web 框架 |
| MySQL | 8.0 | 数据库 |
| mysql2 | - | MySQL 驱动 |
| uuid | - | ID 生成 |

### 2.3 外部依赖
| 服务 | 地址 | 用途 |
|------|------|------|
| 数据中台 | http://115.190.44.247 | 元数据管理 |
| 智能体平台 | https://qj.agentspro.cn | AI 能力 |

---

## 3. 前端页面结构

```
src/pages/
├── Dashboard.tsx        # 仪表盘首页
├── ProjectList.tsx      # 项目列表
├── NewProject.tsx       # 新建项目（上传招标文件）
├── ProjectConfirm.tsx   # 招标文件字段确认
├── ProjectWorkspace.tsx # 项目工作区（入口）
├── ProjectFiles.tsx     # 项目资料管理（文件分拣/提取）
├── FileFields.tsx       # 文件字段详情
├── ProjectLedger.tsx    # 项目台账（四选项卡）
├── ProjectAudit.tsx     # 审计执行
├── ProjectRisks.tsx     # 风险报告
└── AuditRules.tsx       # 审计规则管理
```

### 3.1 页面导航流程

```
项目列表 ──────► 新建项目 ──────► 字段确认 ──────► 项目工作区
    │                                                  │
    └──────────────────────────────────────────────────┤
                                                       ▼
                          ┌────────────────────────────┴────────────────────────┐
                          │                                                     │
                          ▼                    ▼                    ▼           ▼
                     项目资料            项目台账            审计执行      风险报告
                     (文件分拣)          (数据展示)          (规则审计)    (风险汇总)
                          │
                          ▼
                     文件字段详情
                     (提取/修改)
```

---

## 4. 数据库设计

### 4.1 表结构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              App端数据库 (MySQL)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐                                                        │
│  │    projects     │◄──────────────────────────────────────────┐            │
│  │─────────────────│                                           │            │
│  │ id (PK)         │                                           │            │
│  │ name            │                                           │            │
│  │ status          │                                           │            │
│  │ tender_file_id  │                                           │            │
│  │ tender_ds_id    │                                           │            │
│  │ tender_file_url │                                           │            │
│  │ created_at      │                                           │            │
│  └────────┬────────┘                                           │            │
│           │                                                    │            │
│           │ 1:N                                                │            │
│           ▼                                                    │            │
│  ┌─────────────────┐           1:N           ┌─────────────────┐            │
│  │  project_files  │────────────────────────►│   file_fields   │            │
│  │─────────────────│                         │─────────────────│            │
│  │ id (PK)         │                         │ id (PK)         │            │
│  │ project_id (FK) │                         │ file_id (FK)    │            │
│  │ file_name       │                         │ project_id (FK) │            │
│  │ file_id         │                         │ field_code      │            │
│  │ ds_id           │                         │ field_name      │            │
│  │ doc_type_code   │                         │ field_value     │            │
│  │ doc_type_name   │                         │ status          │            │
│  │ is_tender       │                         │ group_name      │            │
│  │ status          │                         │ evidence_page   │            │
│  │ extraction_status│                        │ evidence_bbox   │            │
│  └─────────────────┘                         └─────────────────┘            │
│                                                                             │
│  ┌─────────────────┐           ┌─────────────────┐                         │
│  │  audit_risks    │           │  audit_rules    │                         │
│  │─────────────────│           │─────────────────│                         │
│  │ id (PK)         │           │ id (PK)         │                         │
│  │ project_id (FK)─┼───────────┤ source_id       │                         │
│  │ rule_code       │           │ code            │                         │
│  │ rule_name       │           │ name            │                         │
│  │ risk_level      │           │ description     │                         │
│  │ description     │           │ category        │                         │
│  │ suggestion      │           │ stage           │                         │
│  │ status          │           │ is_enabled      │                         │
│  │ evidence        │           │ synced_at       │                         │
│  └─────────────────┘           └─────────────────┘                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 表详细说明

#### projects（项目表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(64) | 项目ID (UUID) |
| name | VARCHAR(255) | 项目名称 |
| status | VARCHAR(32) | 项目状态 |
| tender_file_id | VARCHAR(64) | 招标文件ID（智能体平台） |
| tender_ds_id | INT | 招标文件知识库数据集ID |
| tender_file_url | VARCHAR(512) | 招标文件预览URL |

**项目状态值：** draft → uploading → parsing → extracting → confirming → ready → auditing → completed → error

#### project_files（项目文件表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | VARCHAR(64) | 文件记录ID (UUID) |
| project_id | VARCHAR(64) | 所属项目ID |
| file_name | VARCHAR(255) | 文件名 |
| file_id | VARCHAR(64) | 智能体平台文件ID |
| ds_id | INT | 知识库数据集ID |
| doc_type_code | VARCHAR(64) | 文件类型编码 |
| doc_type_name | VARCHAR(128) | 文件类型名称 |
| is_tender | BOOLEAN | 是否为招标文件 |
| status | ENUM | 分类状态（pending/classified/confirmed） |
| extraction_status | ENUM | 提取状态（pending/processing/completed/failed） |

#### file_fields（文件字段值表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 自增主键 |
| file_id | VARCHAR(64) | 所属文件ID |
| project_id | VARCHAR(64) | 所属项目ID |
| field_code | VARCHAR(64) | 字段编码 |
| field_name | VARCHAR(128) | 字段名称 |
| field_value | TEXT | 字段值 |
| status | ENUM | 状态（auto/confirmed/modified/missing/pending） |
| group_name | VARCHAR(64) | 字段分组 |
| evidence_page | INT | 原文页码 |
| evidence_bbox | JSON | 原文位置坐标 |

#### audit_risks（审计风险表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 自增主键 |
| project_id | VARCHAR(64) | 所属项目ID |
| rule_code | VARCHAR(64) | 规则编码 |
| rule_name | VARCHAR(255) | 规则名称 |
| risk_level | VARCHAR(32) | 风险等级（critical/high/medium/low） |
| description | TEXT | 风险描述 |
| suggestion | TEXT | 处理建议 |
| status | VARCHAR(32) | 状态（pending/confirmed/ignored/resolved） |
| evidence | JSON | 证据信息 |

---

## 5. 核心业务流程

### 5.1 新建项目流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  用户    │     │  App端   │     │ 数据中台 │     │ 智能体   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 1.进入新建页面 │                │                │
     │───────────────►│                │                │
     │                │ 2.获取招标文件字段定义          │
     │                │───────────────►│                │
     │                │◄───────────────│                │
     │                │                │                │
     │ 3.上传招标文件 │                │                │
     │───────────────►│                │                │
     │                │ 4.上传到智能体平台              │
     │                │───────────────────────────────►│
     │                │◄───────────────────────────────│
     │                │ 5.创建知识库+解析               │
     │                │───────────────────────────────►│
     │                │◄───────────────────────────────│
     │                │ 6.逐字段调用提取Agent           │
     │                │───────────────────────────────►│
     │                │◄───────────────────────────────│
     │◄───────────────│ 7.展示提取结果                 │
     │                │                │                │
     │ 8.确认/修改    │                │                │
     │───────────────►│                │                │
     │                │ 9.保存到数据库(project_files + file_fields)
     │◄───────────────│                │                │
     │ 项目创建成功   │                │                │
```

### 5.2 文件分拣与提取流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  用户    │     │  App端   │     │ 数据中台 │     │ 智能体   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 1.上传文件     │                │                │
     │───────────────►│                │                │
     │                │ 2.上传到智能体平台              │
     │                │───────────────────────────────►│
     │                │◄───────────────────────────────│
     │                │ 3.获取文件类型列表              │
     │                │───────────────►│                │
     │                │◄───────────────│                │
     │                │ 4.调用分拣Agent                 │
     │                │───────────────────────────────►│
     │                │◄───────────────────────────────│
     │◄───────────────│ 5.展示分拣结果                 │
     │                │                │                │
     │ 6.确认文件类型 │                │                │
     │───────────────►│                │                │
     │                │ 7.获取字段定义(按文件类型)      │
     │                │───────────────►│                │
     │                │◄───────────────│                │
     │                │ 8.自动开始提取                  │
     │                │───────────────────────────────►│
     │                │◄───────────────────────────────│
     │◄───────────────│ 9.提取完成                     │
```

### 5.3 审计执行流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  用户    │     │  App端   │     │ 数据中台 │     │ 审计Agent│
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 1.进入审计页面 │                │                │
     │───────────────►│                │                │
     │                │ 2.获取审计规则列表              │
     │                │───────────────►│                │
     │                │◄───────────────│                │
     │◄───────────────│ 3.展示规则列表                 │
     │                │                │                │
     │ 4.选择规则执行 │                │                │
     │───────────────►│                │                │
     │                │ 5.获取规则详情(字段+法规)       │
     │                │───────────────►│                │
     │                │◄───────────────│                │
     │                │ 6.从数据库读取字段值            │
     │                │ 7.逐规则调用审计Agent           │
     │                │───────────────────────────────►│
     │                │◄───────────────────────────────│
     │                │  返回: 存在问题/不存在问题/需要复核
     │◄───────────────│ 8.展示审计结果                 │
     │                │                │                │
     │ 9.确认结果     │                │                │
     │───────────────►│                │                │
     │                │ 10.保存到audit_risks表         │
     │◄───────────────│                │                │
```

---

## 6. API 接口清单

### 6.1 App 端后端 API (端口: 8080)

| 接口 | 方法 | 用途 |
|------|------|------|
| `/api/app/projects` | GET | 获取项目列表 |
| `/api/app/projects` | POST | 创建项目 |
| `/api/app/projects/:id` | GET | 获取项目详情 |
| `/api/app/projects/:id` | PUT | 更新项目 |
| `/api/app/projects/:id` | DELETE | 删除项目 |
| `/api/app/projects/:id/files` | GET | 获取项目文件列表 |
| `/api/app/projects/:id/files` | POST | 添加项目文件 |
| `/api/app/projects/:id/files/:fileId` | PUT | 更新文件信息 |
| `/api/app/projects/:id/files/:fileId` | DELETE | 删除文件 |
| `/api/app/projects/:id/files/:fileId/fields` | GET | 获取文件字段 |
| `/api/app/projects/:id/files/:fileId/fields` | PUT | 批量更新字段 |
| `/api/app/projects/:id/all-fields` | GET | 获取所有字段(台账用) |
| `/api/app/projects/:id/risks` | GET | 获取风险列表 |
| `/api/app/projects/:id/risks` | POST | 添加风险 |
| `/api/app/projects/:id/risks/:riskId` | PUT | 更新风险 |
| `/api/app/projects/:id/risks/:riskId` | DELETE | 删除风险 |
| `/api/app/audit-rules` | GET | 获取本地规则 |
| `/api/app/audit-rules/sync` | POST | 同步数据中台规则 |

### 6.2 数据中台 API

| 接口 | 方法 | 用途 |
|------|------|------|
| `/api/v1/doc-types/all` | GET | 获取所有文件类型 |
| `/api/v1/doc-types/full/{code}` | GET | 获取类型详情含字段 |
| `/api/v1/doc-field-defs/by-doc-type/{id}` | GET | 获取字段定义 |
| `/api/v1/audit-rules/list` | GET | 获取审计规则列表 |
| `/api/v1/audit-rules/all` | GET | 获取启用的规则 |
| `/api/v1/audit-rule-field-links/by-rule/{id}` | GET | 规则关联字段 |
| `/api/v1/audit-rule-law-links/by-rule/{id}` | GET | 规则关联法规 |

### 6.3 智能体平台 API

| 接口 | 方法 | 用途 |
|------|------|------|
| `/openapi/fs/upload` | POST | 上传文件 |
| `/openapi/kb/createDsAndTask` | POST | 创建知识库数据集 |
| `/openapi/kb/ds/query` | POST | 查询解析状态 |
| `/openapi/v2/chat/completions` | POST | 调用智能体 |

---

## 7. 状态流转

### 7.1 项目状态

```
uploading ──► extracting ──► auditing ──► completed
    │              │             │
    │              │             └── 执行过审计，点击完成按钮后变为 completed
    │              └────────────── 有文件，未执行过审计
    └───────────────────────────── 只有招标文件，未上传其他文件
```

| 状态 | 含义 | 触发条件 |
|------|------|----------|
| uploading | 待上传 | 只有招标文件，未上传其他文件 |
| extracting | 提取中 | 有其他文件，未执行过审计 |
| auditing | 审计中 | 执行过审计，未点击完成 |
| completed | 已完成 | 点击"完成项目"按钮 |

### 7.2 文件状态

```
分类状态 (status):
pending ──────► classified ──────► confirmed
   │                │                   │
   │                │                   └── 用户确认文件类型
   │                └───────────────────── AI分拣完成
   └────────────────────────────────────── 刚上传

提取状态 (extraction_status):
pending ──────► processing ──────► completed
   │                │                   │
   │                │                   └── 提取完成
   │                └───────────────────── 正在提取
   └────────────────────────────────────── 等待提取
                    │
                    └──────────────► failed (提取失败)
```

### 7.3 字段状态

```
auto ──────────► confirmed        自动提取 → 用户确认
   │                │
   │                └─► modified  用户修改
   │
missing ───────────────────────── 未找到/提取失败
```

---

## 8. 项目台账选项卡设计

### 8.1 四个选项卡

| 选项卡 | 字段列表 |
|--------|----------|
| **项目基本信息** | 项目名称、服务范围/建设规模、招标方式、项目估算金额、最高投标限价、合同价格形式、服务期限、合同金额、合同签订时间 |
| **招标关键信息** | 招标方案审核时间、招标公告发布时间、招标文件获取时间、投标截止时间、开标时间、资格审查方式、评标方法、评标委员会组成、投标保证金、废标条款、评标标准 |
| **中标关键信息** | 中标候选人公示开始时间、中标候选人名单、中标通知书发送时间、中标人公司名称、中标金额 |
| **投标人关键信息** | 投标人公司名称、投标人联系电话、投标人资格条件(资质/负责人/业绩)、法定代表人授权委托书人员信息、投标报价（按投标人分组展示） |

### 8.2 字段状态图标

| 状态 | 图标 | 含义 |
|------|------|------|
| confirmed | ✅ 绿色勾 | 已确认 |
| auto/modified | 🔵 蓝色圆 | 有值待确认 |
| missing | ⚠️ 黄色感叹号 | 缺失 |

---

## 9. 导出功能

### 9.1 项目台账导出

- **格式**: Excel (.xlsx)
- **内容**: 每个选项卡生成一个工作表
- **列**: 序号、字段名称、字段值、状态
- **文件名**: `{项目名}_项目台账_{日期}.xlsx`

### 9.2 风险报告导出

- **格式**: Excel (.xlsx)
- **内容**:
  - 风险统计摘要（高/中/低风险数量）
  - 风险详情表
- **列**: 序号、规则名称、规则编码、风险等级、风险描述、处理建议
- **文件名**: `{项目名}_风险报告_{日期}.xlsx`

---

## 10. 后台任务管理

### 10.1 TaskContext

管理以下后台任务：
- 文件上传 (upload)
- 文件解析 (parse)
- 文件分拣 (classify)
- 字段提取 (extract)
- 审计执行 (audit)

### 10.2 AuditContext

管理审计会话状态：
- 按项目ID存储审计进度
- 支持页面切换不中断
- 自动保存审计结果到数据库

---

## 11. 配置信息

### 11.1 环境配置

| 环境变量 | 默认值 | 说明 |
|----------|--------|------|
| VITE_DATA_HUB_URL | http://115.190.44.247 | 数据中台地址 |
| VITE_AGENT_ENV | qj | 智能体环境 (qj/prod) |
| DB_HOST | localhost | 数据库主机 |
| DB_PORT | 3306 | 数据库端口 |
| DB_USER | root | 数据库用户 |
| DB_PASSWORD | - | 数据库密码 |
| DB_DATABASE | audit_app | 数据库名 |

### 11.2 智能体配置

| 配置项 | qj环境 | prod环境 |
|--------|--------|----------|
| 平台地址 | https://qj.agentspro.cn | https://agentspro.cn |
| 知识库ID | 761 | 待配置 |
| 提取Agent | ZTGCSC00000001 | 待配置 |
| 分拣Agent | ZTGCSC00000002 | 待配置 |
| 审计Agent | ZTGCSC00000003 | 待配置 |

### 11.3 超时配置

- API 请求超时: 10 分钟 (600000ms)
- 智能体调用超时: 10 分钟 (600000ms)

---

## 12. 错误处理

| 场景 | 处理方式 |
|------|----------|
| 智能体调用超时 | 显示错误提示，支持重试 |
| 智能体返回格式错误 | 标记为 missing/review |
| 知识库解析失败 | 提示用户重新上传 |
| 数据中台不可用 | 显示错误提示 |
| 文件分拣失败 | 支持重新分拣 |
| 字段提取失败 | 支持重新提取 |
| 审计执行失败 | 记录错误，继续下一条 |

---

## 13. 已实现功能清单

- [x] 项目创建与管理
- [x] 招标文件上传与解析
- [x] 招标文件字段提取
- [x] 字段确认与编辑
- [x] 文件批量上传
- [x] 文件智能分拣
- [x] 分拣结果确认
- [x] 按文件类型字段提取
- [x] 文件重新分拣/提取
- [x] 文件删除
- [x] 项目台账展示(四选项卡)
- [x] 台账导出 Excel
- [x] 审计规则同步
- [x] 审计执行(后台运行)
- [x] 审计结果确认
- [x] 风险报告展示
- [x] 风险报告导出 Excel
- [x] 后台任务管理
- [x] 文件预览(PDF/图片)

---

## 14. 待优化事项

- [ ] 多文件并行提取优化
- [ ] 增量审计（新增文件后）
- [ ] Word 文件在线预览
- [ ] 项目数据备份/恢复
- [ ] 操作日志记录
- [ ] 用户权限管理
